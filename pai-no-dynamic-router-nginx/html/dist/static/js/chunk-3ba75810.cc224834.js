(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3ba75810"],{"91b6":function(e,t,s){"use strict";s.d(t,"g",(function(){return n})),s.d(t,"b",(function(){return i})),s.d(t,"f",(function(){return r})),s.d(t,"c",(function(){return c})),s.d(t,"a",(function(){return u})),s.d(t,"d",(function(){return l})),s.d(t,"e",(function(){return o}));s("99af");var a=s("b775");function n(e){return Object(a["a"])({url:"/upload/verifyFile",method:"post",data:e})}function i(e,t){return Object(a["a"])({url:"/upload/dataset/".concat(e,"/").concat(t),method:"put"})}function r(e,t,s){return Object(a["a"])({url:"/upload/chunk",method:"post",data:e,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:t,cancelToken:s})}function c(e,t){return Object(a["a"])({url:"/upload/fileInfo/".concat(e,"/").concat(t),method:"put"})}function u(e){return Object(a["a"])({url:"/upload/merge/".concat(e),method:"post"})}function l(e,t){return Object(a["a"])({url:"/upload/unzip/dataset/".concat(e,"/").concat(t),method:"post"})}function o(e,t,s){return Object(a["a"])({url:"/upload/unzip/classify/".concat(e,"/").concat(t,"/").concat(s),method:"post"})}},"96e1":function(e,t,s){"use strict";s("f6ef")},c7f0:function(e,t,s){"use strict";var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{attrs:{title:e.title,visible:e.dialogVisible,width:"700px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!0,"before-close":e.handleClose},on:{"update:visible":function(t){e.dialogVisible=t}}},[s("div",{staticClass:"upload-container"},[s("el-steps",{attrs:{active:e.activeStep,"finish-status":"success","align-center":"",simple:""}},[s("el-step",{attrs:{title:"选择文件"}}),s("el-step",{attrs:{title:"上传文件"}}),s("el-step",{attrs:{title:e.finalStepTitle}})],1),s("div",{directives:[{name:"show",rawName:"v-show",value:0===e.activeStep,expression:"activeStep === 0"}],staticClass:"step-content"},[e.currentFile?e._e():s("el-upload",{ref:"upload",staticClass:"upload-dragger",attrs:{drag:"",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":e.handleFileChange,accept:".zip"}},[s("i",{staticClass:"el-icon-upload"}),s("div",{staticClass:"el-upload__text"},[e._v("将文件拖到此处，或"),s("em",[e._v("点击上传")])]),s("div",{staticClass:"el-upload__tip"},[e._v(" 只能上传zip文件，且不超过"+e._s(e.maxSize)+"GB ")])]),e.calculating?s("div",{staticClass:"calculating-md5"},[s("el-progress",{attrs:{type:"circle",percentage:e.calculateProgress}}),s("div",{staticClass:"calculate-tip"},[e._v("正在计算文件MD5...")])],1):e._e()],1),s("div",{directives:[{name:"show",rawName:"v-show",value:1===e.activeStep,expression:"activeStep === 1"}],staticClass:"step-content"},[e.currentFile?s("div",{staticClass:"file-info"},[s("el-descriptions",{attrs:{title:"文件信息",column:2,border:""}},[s("el-descriptions-item",{attrs:{label:"文件名称"}},[e._v(" "+e._s(e.currentFile.name)+" ")]),s("el-descriptions-item",{attrs:{label:"文件大小"}},[e._v(" "+e._s(e.formatFileSize(e.currentFile.size))+" ")]),s("el-descriptions-item",{attrs:{label:"文件MD5"}},[e._v(" "+e._s(e.fileHash)+" ")]),s("el-descriptions-item",{attrs:{label:"分片数量"}},[e._v(" "+e._s(e.chunks.length)+" ")])],1),s("div",{staticClass:"upload-progress"},[s("div",{staticClass:"progress-header"},[s("span",[e._v("上传进度")])]),s("el-progress",{attrs:{percentage:e.totalProgress,status:e.uploadStatus}})],1),s("div",{staticClass:"chunk-info"},[s("div",{staticClass:"chunk-header"},[s("span",[e._v("分片信息")]),s("el-tag",{attrs:{size:"small",type:e.uploadStatusType}},[e._v(" "+e._s(e.uploadStatusText)+" ")])],1),s("el-table",{attrs:{data:e.chunks,size:"small",height:"200"}},[s("el-table-column",{attrs:{prop:"index",label:"序号",width:"80"}}),s("el-table-column",{attrs:{prop:"size",label:"大小"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatFileSize(t.row.size))+" ")]}}],null,!1,4091220313)}),s("el-table-column",{attrs:{prop:"status",label:"状态",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[s("el-tag",{attrs:{size:"mini",type:e.getChunkStatusType(t.row.status)}},[e._v(" "+e._s(e.getChunkStatusText(t.row.status))+" ")])]}}],null,!1,1816230429)})],1)],1),s("div",{staticClass:"operation-buttons"},[e.uploading||e.isPaused?e._e():s("el-button",{attrs:{type:"primary",disabled:!e.currentFile},on:{click:e.startUpload}},[e._v(" 开始上传 ")]),e.uploading||e.isPaused?s("el-button",{attrs:{type:e.isPaused?"success":"warning"},on:{click:e.handlePauseOrResume}},[e._v(" "+e._s(e.isPaused?"继续上传":"暂停上传")+" ")]):e._e()],1)],1):e._e()]),s("div",{directives:[{name:"show",rawName:"v-show",value:2===e.activeStep,expression:"activeStep === 2"}],staticClass:"step-content"},[s("div",{staticClass:"final-step-content"},[s("el-button",{attrs:{type:"primary",loading:e.processing},on:{click:e.handleArchive}},[e._v(" "+e._s(e.processing?e.finalStepTitle+"中...":e.finalStepTitle)+" ")])],1)])],1)])},n=[],i=s("c7eb"),r=s("1da1"),c=(s("4de4"),s("a630"),s("caad"),s("d81d"),s("13d5"),s("fb6a"),s("b0c0"),s("a9e3"),s("b680"),s("d3b7"),s("2532"),s("3ca3"),s("0643"),s("2382"),s("a573"),s("9d4a"),s("ddb0"),s("69a0")),u=s.n(c),l=s("91b6"),o={name:"UploadDialog",props:{visible:{type:Boolean,default:!1},maxSize:{type:Number,default:5},datasetId:{type:Number,default:null},classifyId:{type:Number,default:null}},data:function(){return{activeStep:0,currentFile:null,calculating:!1,calculateProgress:0,fileHash:"",chunks:[],uploadedChunks:[],chunkSize:5242880,uploading:!1,isPaused:!1,totalProgress:0,processing:!1,isCompleted:!1,dialogVisible:!1,maxConcurrent:10}},computed:{title:function(){return this.classifyId?"上传分类":"上传数据集"},finalStepTitle:function(){return this.classifyId?"归档分类":"归档数据集"},uploadStatus:function(){return 100===this.totalProgress?"success":this.isPaused?"exception":null},uploadStatusText:function(){return this.uploading?"上传中":this.isPaused?"已暂停":100===this.totalProgress?"上传完成":"等待上传"},uploadStatusType:function(){return this.uploading?"primary":this.isPaused?"warning":100===this.totalProgress?"success":"info"},getChunkStatusType:function(){return function(e){switch(e){case"success":return"success";case"uploading":return"primary";case"error":return"danger";case"waiting":default:return"info"}}},getChunkStatusText:function(){return function(e){switch(e){case"success":return"已完成";case"uploading":return"上传中";case"error":return"失败";case"waiting":default:return"等待中"}}}},watch:{visible:{handler:function(e){this.dialogVisible=e},immediate:!0}},methods:{handleFileChange:function(e){"application/x-zip-compressed"===e.raw.type?e.size>1024*this.maxSize*1024*1024?this.$message.error("文件大小不能超过".concat(this.maxSize,"GB！")):(this.currentFile=e.raw,this.calculating=!0,this.calculateHash()):this.$message.error("只能上传zip格式的文件！")},calculateHash:function(){var e=this,t=new u.a.ArrayBuffer,s=Math.ceil(this.currentFile.size/this.chunkSize),a=0,n=function(){if(!1!==e.calculating){var i=new FileReader,r=a*e.chunkSize,c=Math.min(r+e.chunkSize,e.currentFile.size);i.onload=function(i){t.append(i.target.result),a++,a<s?(e.calculateProgress=Math.floor(a/s*100),setTimeout(n,0)):(e.calculateProgress=100,e.calculating=!1,e.fileHash=t.end(),e.verifyFile())},i.onerror=function(){e.$message.error("文件读取失败"),e.calculating=!1},i.readAsArrayBuffer(e.currentFile.slice(r,c))}};this.calculating=!0,this.calculateProgress=0,n()},verifyFile:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){var s,a,n,r;return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,Object(l["g"])({fileHash:e.fileHash,fileName:e.currentFile.name,chunkSize:e.chunkSize,fileSize:e.currentFile.size});case 2:s=t.sent,200===s.code&&(a=s.data,n=a.uploaded,r=a.uploadedChunks,n?(e.$message({message:"文件已上传，即将跳转到归档步骤",type:"success",duration:1e3}),setTimeout((function(){e.activeStep=2}),1500)):(e.uploadedChunks=r||[],e.prepareUpload(),e.$message({message:"文件校验完成，即将开始上传",type:"success",duration:1e3}),setTimeout((function(){e.activeStep=1}),1e3)));case 4:case"end":return t.stop()}}),t)})))()},prepareUpload:function(){var e=this,t=Math.ceil(this.currentFile.size/this.chunkSize);this.chunks=Array.from({length:t},(function(s,a){return{index:a,size:a===t-1?e.currentFile.size-(t-1)*e.chunkSize:e.chunkSize,status:e.uploadedChunks.includes(a)?"success":"waiting",progress:e.uploadedChunks.includes(a)?100:0}}))},startUpload:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){var s,a,n;return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.uploading=!0,t.next=3,Object(l["c"])(e.fileHash,1);case 3:s=e.chunks.filter((function(e){return"success"!==e.status})),a=0;case 5:if(!(a<s.length)){t.next=14;break}if(!e.isPaused){t.next=8;break}return t.abrupt("break",14);case 8:return n=s.slice(a,a+e.maxConcurrent).map((function(t){return e.uploadChunk(t)})),t.next=11,Promise.all(n);case 11:a+=e.maxConcurrent,t.next=5;break;case 14:if(e.isPaused){t.next=18;break}return e.totalProgress=100,t.next=18,e.mergeFile();case 18:case"end":return t.stop()}}),t)})))()},uploadChunk:function(e){var t=this;return Object(r["a"])(Object(i["a"])().mark((function s(){var a,n,r;return Object(i["a"])().wrap((function(s){while(1)switch(s.prev=s.next){case 0:if(!t.isPaused){s.next=4;break}return e.status="waiting",e.progress=0,s.abrupt("return");case 4:return a=new FormData,n=e.index*t.chunkSize,r=n+e.size,a.append("file",t.currentFile.slice(n,r)),a.append("fileHash",t.fileHash),a.append("chunkIndex",e.index),s.prev=10,e.status="uploading",s.next=14,Object(l["f"])(a,(function(s){var a=Math.round(100*s.loaded/s.total);e.progress=a,t.updateTotalProgress()}));case 14:e.status="success",e.progress=100,s.next=22;break;case 18:throw s.prev=18,s.t0=s["catch"](10),e.status="error",s.t0;case 22:case"end":return s.stop()}}),s,null,[[10,18]])})))()},updateTotalProgress:function(){var e=this.chunks.length,t=this.chunks.reduce((function(e,t){return e+(t.progress||0)}),0);this.totalProgress=Math.floor(t/e)},mergeFile:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.$message({message:"文件上传完成，开始合并分片",type:"success",duration:1e3}),t.next=3,Object(l["a"])(e.fileHash);case 3:e.uploading=!1,e.activeStep=2;case 5:case"end":return t.stop()}}),t)})))()},handleArchive:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.processing=!0,e.classifyId){t.next=6;break}return t.next=4,Object(l["d"])(e.datasetId,e.fileHash);case 4:t.next=8;break;case 6:return t.next=8,Object(l["e"])(e.datasetId,e.classifyId,e.fileHash);case 8:e.$message({message:"归档完成",type:"success",duration:1e3}),e.isCompleted=!0,e.processing=!1,e.handleClose();case 12:case"end":return t.stop()}}),t)})))()},pauseUpload:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,Object(l["c"])(e.fileHash,2);case 2:e.isPaused=!0,e.uploading=!1;case 4:case"end":return t.stop()}}),t)})))()},resumeUpload:function(){var e=this;return Object(r["a"])(Object(i["a"])().mark((function t(){var s,a,n;return Object(i["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,Object(l["c"])(e.fileHash,1);case 2:e.isPaused=!1,e.uploading=!0,s=e.chunks.filter((function(e){return"success"!==e.status})),a=0;case 6:if(!(a<s.length)){t.next=15;break}if(!e.isPaused){t.next=9;break}return t.abrupt("break",15);case 9:return n=s.slice(a,a+e.maxConcurrent).map((function(t){return e.uploadChunk(t)})),t.next=12,Promise.all(n);case 12:a+=e.maxConcurrent,t.next=6;break;case 15:if(e.isPaused||100!==e.totalProgress){t.next=18;break}return t.next=18,e.mergeFile();case 18:case"end":return t.stop()}}),t)})))()},handlePauseOrResume:function(){this.isPaused?this.resumeUpload():this.pauseUpload()},handleClose:function(){var e=this;this.calculating?this.$message({message:"正在计算文件MD5，无法关闭！！！",type:"warning"}):this.uploading?this.$message({message:"文件正在上传中，无法关闭！！！",type:"warning"}):this.processing?this.$message({message:"文件正在归档中，无法关闭！！！",type:"warning"}):this.currentFile&&!this.isCompleted?this.$confirm("关闭将取消本次上传任务，是否继续？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1}).then((function(){e.reset(),e.classifyId?e.$emit("update:visible"):Object(l["b"])(e.datasetId,0).then((function(){e.$emit("update:visible")}))})).catch((function(){})):this.currentFile?this.isCompleted&&(this.reset(),this.$emit("update:visible")):(this.reset(),this.classifyId?this.$emit("update:visible"):Object(l["b"])(this.datasetId,0).then((function(){e.$emit("update:visible")})))},reset:function(){this.activeStep=0,this.currentFile=null,this.calculating=!1,this.calculateProgress=0,this.fileHash="",this.chunks=[],this.uploadedChunks=[],this.uploading=!1,this.isPaused=!1,this.totalProgress=0,this.processing=!1},formatFileSize:function(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1048576).toFixed(2)+" MB":(e/1073741824).toFixed(2)+" GB"}}},d=o,p=(s("96e1"),s("2877")),h=Object(p["a"])(d,a,n,!1,null,"061f747e",null);t["a"]=h.exports},f6ef:function(e,t,s){}}]);